{
    # Enable debug mode for development
    debug

    # Auto HTTPS off for development
    auto_https off

    order php_server before file_server
}

:80 {
    # Document root
    root * /var/www/html

    # Enable compression
    encode gzip

    # PHP Handler für FrankenPHP
    php_server

    # Exclude assets from being handled by router
    @assets path /admin/assets*
    file_server @assets

    # Error pages
    handle_errors 404 {
        rewrite * /404.html
        php_server
    }

    # Google sitemap
    rewrite /sitemap.xml /index.php
    rewrite /sitemap.gz /index.php
    rewrite /sitemap.xml.gz /index.php

    # Tags pages with page count
    @tags_page path_regexp tags_page ^/tags/([0-9]+)/([0-9]+)/(.+)\.html?$
    rewrite @tags_page /index.php?action=search&tagging_id={re.tags_page.1}&seite={re.tags_page.2}

    # Tags pages
    @tags path_regexp tags ^/tags/([0-9]+)/([^/]+)\.html?$
    rewrite @tags /index.php?action=search&tagging_id={re.tags.1}

    # Setup and update pages
    @setup path /setup*
    rewrite @setup /setup/index.php

    # Administration API
    @admin_api path /admin/api*
    rewrite @admin_api /admin/api/index.php

    # Administration pages
    @admin path /admin*
    rewrite @admin /admin/index.php

    # Private APIs
    @api path_regexp api ^/api/(autocomplete|bookmark/delete|bookmark/create|user/data/update|user/password/update|user/request-removal|user/remove-twofactor|contact|voting|register|captcha|share|comment/create|faq/create|question/create|webauthn/prepare|webauthn/register|webauthn/prepare-login|webauthn/login)$
    rewrite @api /api/index.php

    # Setup APIs
    @api_setup path_regexp api_setup ^/api/setup/(check|backup|update-database)$
    rewrite @api_setup /api/index.php

    # REST API v3.0 and v3.1
    @api_v3 path_regexp api_v3 ^/api/v3\.[01]/(.*)$
    rewrite @api_v3 /api/index.php

    file_server

    header {
        X-Frame-Options DENY
        X-Content-Type-Options nosniff
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
    }

    log {
        output stdout
        format console
        level DEBUG
    }
}

:443 {
    # Document root
    root * /var/www/html

    # Enable compression
    encode gzip

    # TLS configuration with your certificate files
    tls /etc/ssl/cert.pem /etc/ssl/cert-key.pem

    php_server

    # Gleiche Rewrite-Regeln wie für Port 80
    @assets path /admin/assets*
    file_server @assets

    handle_errors 404 {
        rewrite * /404.html
        php_server
    }

    # Google sitemap
    rewrite /sitemap.xml /index.php
    rewrite /sitemap.gz /index.php
    rewrite /sitemap.xml.gz /index.php

    # Tags pages with page count
    @tags_page path_regexp tags_page ^/tags/([0-9]+)/([0-9]+)/(.+)\.html?$
    rewrite @tags_page /index.php?action=search&tagging_id={re.tags_page.1}&seite={re.tags_page.2}

    # Tags pages
    @tags path_regexp tags ^/tags/([0-9]+)/([^/]+)\.html?$
    rewrite @tags /index.php?action=search&tagging_id={re.tags.1}

    @setup path /setup*
    rewrite @setup /setup/index.php

    @update path /update*
    rewrite @update /update/index.php

    @admin_api path /admin/api*
    rewrite @admin_api /admin/api/index.php

    @admin path /admin*
    rewrite @admin /admin/index.php

    @api path_regexp api ^/api/(autocomplete|bookmark/delete|bookmark/create|user/data/update|user/password/update|user/request-removal|user/remove-twofactor|contact|voting|register|captcha|share|comment/create|faq/create|question/create|webauthn/prepare|webauthn/register|webauthn/prepare-login|webauthn/login)$
    rewrite @api /api/index.php

    @api_setup path_regexp api_setup ^/api/setup/(check|backup|update-database)$
    rewrite @api_setup /api/index.php

    @api_v3 path_regexp api_v3 ^/api/v3\.[01]/(.*)$
    rewrite @api_v3 /api/index.php

    file_server

    header {
        X-Frame-Options DENY
        X-Content-Type-Options nosniff
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
    }

    log {
        output stdout
        format console
        level INFO
    }
}
