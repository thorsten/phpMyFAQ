{"version":3,"file":"update.js","sources":["../src/update.ts","../src/configuration/update.ts"],"sourcesContent":["/**\n * Update functions\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at https://mozilla.org/MPL/2.0/.\n *\n * @package   phpMyFAQ\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2023-2025 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      https://www.phpmyfaq.de\n * @since     2023-10-22\n */\n\nimport {\n  handleConfigBackup,\n  handleDatabaseUpdate,\n  handleUpdateInformation,\n  handleUpdateNextStepButton,\n} from './configuration';\n\ndocument.addEventListener('DOMContentLoaded', async () => {\n  handleUpdateNextStepButton();\n  await handleUpdateInformation();\n  await handleConfigBackup();\n  await handleDatabaseUpdate();\n});\n","/**\n * Update functions\n *\n * This Source Code Form is subject to the terms of the Mozilla Public License,\n * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n * obtain one at https://mozilla.org/MPL/2.0/.\n *\n * @package   phpMyFAQ\n * @author    Thorsten Rinne <thorsten@phpmyfaq.de>\n * @copyright 2023-2025 phpMyFAQ Team\n * @license   http://www.mozilla.org/MPL/2.0/ Mozilla Public License Version 2.0\n * @link      https://www.phpmyfaq.de\n * @since     2023-10-22\n */\n\nexport const handleUpdateNextStepButton = (): void => {\n  const nextStepButton = document.getElementById('phpmyfaq-update-next-step-button') as HTMLButtonElement | null;\n  const nextStep = document.getElementById('phpmyfaq-update-next-step') as HTMLInputElement | null;\n\n  if (nextStepButton && nextStep) {\n    nextStepButton.addEventListener('click', (event: MouseEvent): void => {\n      event.preventDefault();\n      window.location.replace(`?step=${nextStep.value}`);\n    });\n  }\n};\n\nexport const handleUpdateInformation = async (): Promise<void> => {\n  if (window.location.href.endsWith('/update/') || window.location.href.endsWith('/update/index.php')) {\n    const installedVersion = document.getElementById('phpmyfaq-update-installed-version') as HTMLInputElement | null;\n\n    if (!installedVersion) return;\n\n    try {\n      const response = await fetch('../api/setup/check', {\n        method: 'POST',\n        headers: {\n          Accept: 'application/json, text/plain, */*',\n          'Content-Type': 'application/json',\n        },\n        body: installedVersion.value,\n      });\n\n      if (!response.ok) {\n        const errorMessage = await response.json();\n        throw new Error(errorMessage.message);\n      }\n\n      const button = document.getElementById('phpmyfaq-update-next-step-button') as HTMLButtonElement | null;\n      const alert = document.getElementById('phpmyfaq-update-check-success') as HTMLElement | null;\n\n      if (alert && button) {\n        alert.classList.remove('d-none');\n        button.classList.remove('disabled');\n        button.disabled = false;\n      }\n    } catch (error: any) {\n      let errorMessage: string;\n      if (error instanceof SyntaxError) {\n        errorMessage =\n          'The requested resource was not found on the server. ' +\n          'Please check your server configuration, if you use Apache, the RewriteBase in your .htaccess ' +\n          'configuration. If you use nginx, please check your nginx rewrite configuration.';\n      } else {\n        errorMessage = error.message;\n      }\n      const alert = document.getElementById('phpmyfaq-update-check-alert') as HTMLElement | null;\n      const alertResult = document.getElementById('phpmyfaq-update-check-result') as HTMLElement | null;\n\n      if (alert && alertResult) {\n        alert.classList.remove('d-none');\n        alertResult.innerText = errorMessage;\n      }\n    }\n  }\n};\n\nexport const handleConfigBackup = async (): Promise<void> => {\n  if (window.location.href.endsWith('/update/?step=2') || window.location.href.endsWith('/update/index.php?step=2')) {\n    const installedVersion = document.getElementById('phpmyfaq-update-installed-version') as HTMLInputElement | null;\n\n    if (!installedVersion) return;\n\n    try {\n      const response = await fetch('../api/setup/backup', {\n        method: 'POST',\n        headers: {\n          Accept: 'application/json, text/plain, */*',\n          'Content-Type': 'application/json',\n        },\n        body: installedVersion.value,\n      });\n\n      if (!response.ok) {\n        throw new Error('Network response was not ok');\n      }\n\n      const data = await response.json();\n      const downloadLink = document.getElementById('phpmyfaq-update-backup-download-link') as HTMLAnchorElement | null;\n      if (downloadLink) {\n        downloadLink.href = data.backupFile;\n      }\n    } catch (error: any) {\n      const errorMessage =\n        error.cause && error.cause.response ? await error.cause.response.json() : { error: 'Unknown error' };\n      console.error(errorMessage.error);\n    }\n  }\n};\n\nexport const handleDatabaseUpdate = async (): Promise<void> => {\n  if (window.location.href.endsWith('/update/?step=3') || window.location.href.endsWith('/update/index.php?step=3')) {\n    const installedVersion = document.getElementById('phpmyfaq-update-installed-version') as HTMLInputElement | null;\n\n    if (!installedVersion) return;\n\n    try {\n      const response = await fetch('../api/setup/update-database', {\n        method: 'POST',\n        headers: {\n          Accept: 'application/json, text/plain, */*',\n          'Content-Type': 'application/json',\n        },\n        body: installedVersion.value,\n      });\n\n      const result = await response.json();\n      const progressBarInstallation = document.getElementById('result-update') as HTMLElement | null;\n\n      if (response.ok) {\n        if (progressBarInstallation) {\n          progressBarInstallation.style.width = '100%';\n          progressBarInstallation.innerText = '100%';\n          progressBarInstallation.classList.remove('progress-bar-animated');\n        }\n        const alert = document.getElementById('phpmyfaq-update-database-success') as HTMLElement | null;\n        if (alert) {\n          alert.classList.remove('d-none');\n          alert.innerText = result.success;\n        }\n      } else {\n        if (progressBarInstallation) {\n          progressBarInstallation.style.width = '100%';\n          progressBarInstallation.innerText = '100%';\n          progressBarInstallation.classList.remove('progress-bar-animated');\n        }\n        const alert = document.getElementById('phpmyfaq-update-database-error') as HTMLElement | null;\n        const errorMessage = document.getElementById('error-messages') as HTMLElement | null;\n        if (alert && errorMessage) {\n          alert.classList.remove('d-none');\n          errorMessage.innerHTML = result.error;\n        }\n      }\n    } catch (error: any) {\n      console.error('Error details:', error);\n      const alert = document.getElementById('phpmyfaq-update-database-error') as HTMLElement | null;\n      if (alert) {\n        alert.classList.remove('d-none');\n        alert.innerText = `Error: ${error.message}`;\n      }\n    }\n  }\n};\n"],"names":["document","addEventListener","async","nextStepButton","getElementById","nextStep","event","preventDefault","window","location","replace","value","handleUpdateNextStepButton","href","endsWith","installedVersion","response","fetch","method","headers","Accept","body","ok","errorMessage","json","Error","message","button","alert","classList","remove","disabled","error","SyntaxError","alertResult","innerText","handleUpdateInformation","data","downloadLink","backupFile","cause","console","handleConfigBackup","result","progressBarInstallation","style","width","success","innerHTML","handleDatabaseUpdate"],"mappings":"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"}